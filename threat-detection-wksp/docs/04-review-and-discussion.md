# Module 4: Review and Discussion

In the last module we will have a short discussion of the lab (and discuss exactly what occurred.) We will also go over a number of questions and then provide instructions on how to clean up the lab environment (to prevent future charges in your AWS account.) 

### Agenda

1. Review & Discussion – 10 min
2. Questions – 10 min
3. Cleanup – 5 min

## Architecture Overview
Diagram of the overall lab setup:
![Part 1 Diagram](../images/04-diagram-module4.png)

## What is Really Going On?

In **Module 1** of the lab you setup the initial components of your infrastructure including GuardDuty, Macie and a simple notification and remediation pipeline. Some of the steps required manual configuration but you also ran a CloudFormation template which setup some of the components. In **Module 2** you launched a second CloudFormation template that initiated the attack simulated by this lab. The CloudFormation template created two EC2 instances. One instance (named **Malicious Host**) had the EIP attached to it that is in a GuardDuty custom threat list. Although the **Malicious Host** is in the same subnet as the other instance, for the sake of the scenario we acted as if it is on the Internet and represented the attack's computer. The other instance (named **Compromised Instance**) was your web server and it was taken over by the **Malicious Host**. In **Module 3** you investigated the attack, remediated the damage and setup some automated remediations for future attacks.  

Here is what occurred in the attack:	

1. There are two instances created by the Module 2 CloudFormation template. They are in the same VPC but different subnets. The **Malicious Host** represents the attacker which we pretend is on the Internet. The Elastic IP on the **Malicious Host** is in a custom threat list in GuardDuty (in order to generate . The other instance named **Compromised Instance** represents the web server that was lifted and shifted into AWS.
2. Although company policy is that only certificate authentication should be enabled for SSH, at some point password authentication for SSH was enabled on the **Compromised Instance** 
3. The **Malicious Host** performed a brute force SSH password attack against the **Compromised Instance**. The brute force attack is designed to be successful
4. The SSH brute force attack was successful and the attacker was able to log in to the **Compromised Instance** 
5. We pretend here that the attacker then copied the temp credentials (that came from IAM Role for EC2) from the instance to an S3 bucket - in reality the API calls from the **Malicious Host** use the temp creds from the IAM Role for EC2 attached to the **Malicious Host**    
6. The CloudFormation template that we ran in Module 2 enables encryption for the Data bucket and then the EC2 instance removes the encryption. In addition the CloudFormation template made the **Data** bucket public. This is used for the Macie part of the investigation in Module 3. We pretend that the attacker made the bucket public and removed the default encryption from the bucket.
7. The API Calls that generated the API findings come from the **Malicious Host**. The calls use the temp creds from the IAM role for EC2 running on the **Malicious Host**. The GuardDuty findings are generated because the EIP on the **Malicious Host** is in a custom threat list. 
8. ***GuardDuty Finding*** Unauthorized Access - Custom MaliciousIP
9. A number of CloudWatch Events are evoked by the GuardDuty findings and then these trigger various services.
	1. ***CloudWatch Event*** The generic GuardDuty finding invokes a CloudWatch Event rule which triggers SNS to send an email a
	2. ***CloudWatch Event*** The SSH brute force attack finding invokes a CloudWatch Event rule which triggers a Lambda function to block the attacker IP address of the attacker via a NACL as well as a Lambda function that runs an Inspector scan on the EC2 instance.
	3. ***CloudWatch Event*** The Unauthorized Access Custom MaliciousIP finding invokes a CloudWatch Event rule which triggers SNS to send an email and a Lambda function to block the IP address of the attacker via a NACL as well as a Lambda function that runs an Inspector scan on the EC2 instance.

Findings & Alerts:
* ***Macie Alert:*** sensitive data in bucket
* ***Macie Alert:*** alert that encryption was removed from the bucket (generated by the basic alert you created)
* ?????????? ***Macie Alert:*** Bucket made public
* ***GuardDuty Finding:*** Recon:IAMUser/MaliciousIPCaller.Custom & UnauthorizedAccess:IAMUser/MaliciousIPCaller.Custom
* Additional Remediations

### Additional Findings in GuardDuty
There were two findings in GuardDuty that were not part of the attack. These findings are a side effect of the lab setup in order to simulate the attack. These findings are "API CreateThreatIntelSet was invoked from an IP address" & "API ListDetectors, commonly used in reconnaissance attacks, was invoked from an IP address." Do you know why these two findings were generated? Why were they necessary for the lab setup?

### Cleanup
In order to prevent charges to your account we recommend cleaning up the infrastructure that was created. If you plan to keep things running so you can examine the lab a bit more please remember to do the cleanup when you are done. It is very easy to leave things running in an AWS account, forgot about it and then accrue a lot of charges. 

For the Module 1 cleanup you will need to do the following steps manually before deleting the CloudFormation stack: (You must complete the steps below before deleting the Module 1 template.) 

1. Disable Macie (if you didn't already have Macie enabled before the Workshop) - go to the [Macie console](https://mt.us-west-2.macie.aws.amazon.com/), in the upper hand corner select the down arrow next to your IAM user name (or the root user) and select **Macie general settings** then check the two boxes and click **Disable Amazon Macie**
2. Delete all three S3 buckets created by the Module 1 CloudFormation template (the buckets that end with that ends with "-data", "-threatlist" and "-logs")
3. Delete the GuardDuty custom threat list
4. Disable GuardDuty (if you didn't already have GuardDuty enabled before the Workshop) - go to the [GuardDuty console](https://us-west-2.console.aws.amazon.com/guardduty/), select the **General** tab, click the checkbox next to **Disable GuardDuty** then click **Save Settings**, then click **Disable**
5. MAY NOT BE NECESSARY - NEED TO VERIFY AFTER A FEW MORE TESTS you disabled Macie (again only if you didn't already have Macie enabled before the Workshop), delete the CloudTrail trail created for Macie. Go to the [CloudTrail console](https://us-west-2.console.aws.amazon.com/cloudtrail/), click **Trails**, find the Macie CloudTrail trail and delete it.
6. Delete one of the CloudWatch event rules, go to the [CloudWatch console](https://us-west-2.console.aws.amazon.com/cloudwatch), click on Rules under the Events section, click the radio button next **threat-detection-wksp-guardduty-finding-maliciousip**, selection **Action** and click **Delete** then click **Delete** on the pop up box. 
7. Delete the three CloudWatch Logs, go to the [CloudWatch console](https://us-west-2.console.aws.amazon.com/cloudwatch), click on Logs, click the radio button next to **/aws/lambda/threat-detection-wksp-remediation-sshbruteforce**, select **Action** and click **Delete log group** and then click **Yes Delete** , do the same for the following logs: **/threat-detection-wksp/var/log/secure** & **/threat-detection-wksp/vpc-ID#/flowlogs**
8. Delete the Inspector objects created for the workshop, go to the [Inspector Console](https://us-west-2.console.aws.amazon.com/inspector), click on **Assessment targets**, delete the template (the name should start with "td-wksp-target") by clicking on the check box and clicking **Delete** , do the same for **Assessment template**, the name should start with "td-wksp-template" and finally for **Assessment runs**, the name should start with "td-wksp-template-". There may be multiple entries in each section, delete all of them that begin with the text shown above.  
9. Delete the IAM Role for Inspector (if you didn't already have this Role created this), go to the [IAM console](https://console.aws.amazon.com/iam/), **click** on Roles, search for the role named AWSServiceRoleForAmazonInspector, click the check box next to it and click **Delete role**
10. Delete the SNS subscription that was created when you subscribed to SNS Topic, go to the [SNS Console](https://us-west-2.console.aws.amazon.com/sns), click on **Subscriptions**, select the check box next to the subscription that shows your e-mail as the Endpoint and has "threat-detection-wksp" in the "Subscription ARN", select **Action** and then click **Delete subscriptions**
11. For the Module 2 CloudFormation template you can just delete the stack. Open the [CloudFormation console](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks?filter=active), find the Module 2 stack and select **Action** and click **Delete Stack**
12. Now you can delete the CloudFormation template for Module 1. Open the [CloudFormation console](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks?filter=active), find the Module 2 stack and select **Action** and click **Delete Stack**



